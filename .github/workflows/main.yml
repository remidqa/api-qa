name: Build and Deploy Docker Image

on:
  workflow_dispatch:
  #push:
  #  branches:
  #    - main

env:
  APP: api-qa
  ENV: preview

jobs:
  vars:
    runs-on: ubuntu-latest
    outputs:
      APP: ${{ steps.getEnvVars.outputs.APP }}
      ENV: ${{ steps.getEnvVars.outputs.ENV }}
    steps:
      - name: Print inputs passed to the reusable workflow
        id: getEnvVars
        run: |
          echo "APP: $APP" && echo "APP=$APP" >> $GITHUB_OUTPUT
          echo "ENV: $ENV" && echo "ENV=$ENV" >> $GITHUB_OUTPUT

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: docker login
      env:
        DOCKER_USER: ${{ secrets.DOCKER_USER }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      run: docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
    - name: Build docker image
      run: docker build -t $APP .
    - name: Docker tag
      run: docker tag $APP remidandois/$APP
    - name: Docker push
      run: docker push remidandois/$APP      

  execute-tests:
    uses: remidqa/use-guthubactions/.github/workflows/main.yml@main
    needs:
      - vars
    with:
      APP: ${{ needs.vars.outputs.APP }}
      ENV: ${{ needs.vars.outputs.ENV }}
